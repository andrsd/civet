{% extends "ci/base.html" %}
{% load staticfiles %}
{% load humanize %}
{% block title %}Civet: {{pr.title}}{% endblock %}
{% block content %}
<ol class="breadcrumb">
  <li>Pull Request</li>
</ol>
<center>
  <h3>
    <a href="{{pr.url}}">#{{pr.number}}: {{pr.title}} <i class="{{pr.repository.user.server.icon_class}}"></i></a>
  </h3>
</center>
<br/>
<div class="row result_{{pr.status_slug}}" id="pr_status">
  <div class="col-sm-1">Status</div>
  <div id="pr_closed" class="col-sm-5">
    {% if pr.closed %}
      Closed
    {% else %}
      Open
    {% endif %}
  </div>
</div>
<div class="row">
  <div class="col-sm-1">Repository</div>
  <div class="col-sm-5">
    <a href="{% url "ci:view_repo" pr.repository.pk %}">{{pr.repository}}</a>
    <a href="{{pr.url}}"><i class="{{pr.repository.user.server.icon_class}}"></i></a>
  </div>
</div>
<div class="row">
  <div class="col-sm-1">Last modified</div>
  <div class="col-sm-5" id="pr_last_modified">{{pr.last_modified |naturaltime}}</div>
</div>
<div class="row">
  <div class="col-sm-1">Created</div>
  <div class="col-sm-5" id="pr_created">{{pr.created|naturaltime}}</div>
</div>
<center><h3>Events</h3></center>
{% include "ci/event_table.html" %}

<center><h3>Additional Recipes to run</h3></center>
{% if not allowed %}
  You need to be signed in and be a collaborator to add additional recipes.
{% elif form %}
  These recipes will be attached to this PR and will automatically be active when the PR branch is updated.
  <br />
  <br />
  <form id="alt_pr" action="{% url "ci:view_pr" pr.pk %}" method="post">
    {% csrf_token %}
    {{form.as_table}}
    <input type="submit" value="Submit">
  </form>
{% else %}
  There are no additional recipes available
{% endif %}
{% endblock %}

{% block end_scripts %}
{{ block.super }}
<script type="text/javascript" src="{% static "ci/js/update.js" %}"></script>
<script>
function updatePR()
{
  $.ajax({
    url: "{% url "ci:ajax:pr_update" pr.pk %}",
    datatype: 'json',
    success: function(contents) {
      updatePRPage(contents);
    },
    error: function(xhr, textStatus, errorThrown) {
      // alert('Problem with server, no more auto updates');
      //clearInterval(window.status_interval_id);
    }
  });
}


window.status_interval_id = 0;
$(document).ready(function() {
  if( window.status_interval_id == 0 ){
    window.status_interval_id = setInterval(updatePR, {{update_interval}});
  }
});
</script>
{% endblock end_scripts %}
